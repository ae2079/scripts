# Safe Transaction Proposer

This tool allows you to programmatically propose batch transactions to Safe (Gnosis Safe) multisig wallets using the Safe SDK.

## What Does This Do?

This script takes transaction JSON files generated by:
- `../generateRemovePaymentsTransactions.js` - Removes payment streams
- `../pushPaymentTransactionGenerator.js` - Creates new vesting payment streams

And proposes them to your Safe multisig wallet, so other owners can review and approve them.

## Features

- ‚úÖ Proposes single transaction files or entire directories (batch mode)
- ‚úÖ Uses Safe SDK for secure transaction submission
- ‚úÖ Verifies signer is a Safe owner before proposing
- ‚úÖ Provides detailed progress and summary reports
- ‚úÖ Includes rate limiting protection between batches
- ‚úÖ Supports all Safe-compatible chains (Ethereum, Polygon, Arbitrum, etc.)

## Installation

Install the required dependencies:

```bash
cd SafeTransactionProposer
npm install
```

## Prerequisites

Before using this tool, you need:

1. **Transaction files**: Generated by the parent directory scripts
   - Run `node ../generateRemovePaymentsTransactions.js` or
   - Run `node ../pushPaymentTransactionGenerator.js`
   - This creates transaction JSON files in folders like `../X23/removePayment/` or `../X23/pushPayment/`

2. **Private key**: Of a Safe owner account (set as environment variable)

3. **Safe address**: The address of your Safe multisig wallet

## Usage

### Propose a Single Transaction File

```bash
node proposeSafeTransactions.js single ../X23/pushPayment/transactions_X23_batch1_20251012_0000.json
```

### Propose All Transactions in a Directory (Batch Mode) - Recommended

```bash
node proposeSafeTransactions.js batch ../X23/pushPayment
```

### With Custom Safe Address and Chain ID

```bash
node proposeSafeTransactions.js batch ../X23/pushPayment 0xYourSafeAddress 137
```

### Using NPM Scripts

You can also use the provided npm scripts:

```bash
# Propose a single transaction
npm run propose:single ../X23/pushPayment/transactions_X23_batch1.json

# Propose all transactions in a directory
npm run propose:batch ../X23/pushPayment
```

### Alternative: Without .env file

If you prefer not to use a `.env` file, you can pass the private key as an environment variable:

```bash
PRIVATE_KEY=0x... node proposeSafeTransactions.js batch ../X23/pushPayment
```

## Example Workflow

Here's a complete example from start to finish:

```bash
# 1. Generate transactions (in parent directory)
cd ..
node pushPaymentTransactionGenerator.js
# This creates files in ./X23/pushPayment/

# 2. Go to SafeTransactionProposer folder
cd SafeTransactionProposer

# 3. Install dependencies (first time only)
npm install

# 4. Setup your private key in .env file
cp .env.example .env
# Edit .env and add your PRIVATE_KEY

# 5. Propose all transactions to Safe
node proposeSafeTransactions.js batch ../X23/pushPayment
```

## Configuration

You have three ways to configure the script:

### 1. Using .env File (Recommended) üåü

Create a `.env` file (copy from `.env.example`):

```bash
# Required
PRIVATE_KEY=0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

# Optional - Override defaults
SAFE_ADDRESS=0xe077bC743b10833cC938cd5700F92316d5dA11Bf
CHAIN_ID=137
RPC_URL=https://polygon-rpc.com
```

**‚ö†Ô∏è SECURITY**: The `.env` file is in `.gitignore` and will never be committed.

### 2. Edit CONFIG in Code

Edit the `CONFIG` object in `proposeSafeTransactions.js`:

```javascript
const CONFIG = {
    CHAIN_ID: '137',        // Polygon Mainnet
    RPC_URL: 'https://polygon-rpc.com',
    SAFE_ADDRESS: '0xe077bC743b10833cC938cd5700F92316d5dA11Bf'
};
```

### 3. Command Line Arguments

Override Safe address and Chain ID via command line:

```bash
node proposeSafeTransactions.js batch ../X23/pushPayment [SAFE_ADDRESS] [CHAIN_ID]
```

Example:
```bash
node proposeSafeTransactions.js batch ../X23/pushPayment 0xCustomSafe 137
```

### Priority Order

Configuration values are resolved in this order (highest to lowest priority):
1. Command line arguments
2. Environment variables (from `.env` file)
3. Default CONFIG values in code

## Security Best Practices

1. **Never commit private keys**: Always use environment variables or secure key management
2. **Use hardware wallets**: For production, consider using a hardware wallet integration
3. **Verify transactions**: Always review transactions in the Safe UI before executing
4. **Test first**: Use a test Safe on a testnet before proposing to mainnet
5. **Backup**: Keep backups of all generated transaction files

## How It Works

### Transaction Generation Flow

```
User Data ‚Üí Generator Script ‚Üí Transaction JSON Files ‚Üí Safe Transaction Builder Format
```

### Transaction Proposal Flow

```
Transaction JSON ‚Üí proposeSafeTransactions.js ‚Üí Safe SDK ‚Üí Safe API ‚Üí Safe UI
```

1. **Read**: Script reads transaction JSON files
2. **Initialize**: Connects to Safe using SDK with your private key
3. **Verify**: Checks that signer is a Safe owner
4. **Format**: Converts transactions to Safe SDK format
5. **Sign**: Signs the transaction with your private key
6. **Propose**: Submits to Safe Transaction Service
7. **View**: Transaction appears in Safe UI for other owners to approve

## Transaction File Format

Generated transaction files follow the Safe Transaction Builder format:

```json
{
  "version": "1.0",
  "chainId": "137",
  "createdAt": 1234567890,
  "meta": {
    "name": "[PUSH-PAYMENTS]-[X23]-[QACC-ROUND-1]-[TX-0]",
    "description": "Batch 1 for X23"
  },
  "transactions": [
    {
      "to": "0x...",
      "value": "0",
      "data": "0x...",
      "contractMethod": "pushPayment(address,address,uint256,uint256,uint256,uint256)",
      "contractInputsValues": [...]
    }
  ]
}
```

## Troubleshooting

### "Signer is not an owner of Safe"
- Ensure the private key you're using belongs to a Safe owner
- Verify the Safe address is correct
- Check you're connected to the correct network

### "Rate limiting" or "Too many requests"
- The script includes automatic delays between batches (2 seconds)
- If issues persist, increase `delayBetweenBatches` parameter
- Wait a few minutes and try again

### "Network error" or "RPC error"
- Check your internet connection
- Verify RPC_URL is accessible
- Try using a different RPC endpoint (e.g., Alchemy, Infura)

### "Transaction already proposed"
- This transaction hash already exists in the Safe
- Check the Safe UI to see existing pending transactions
- You can skip this transaction or use a different nonce

## Advanced Usage

### Custom RPC Endpoint

```bash
# Edit the CONFIG object in proposeSafeTransactions.js
const CONFIG = {
    RPC_URL: 'https://polygon-mainnet.g.alchemy.com/v2/YOUR_KEY',
    // ...
};
```

### Different Chains

The script supports any chain that Safe supports. Update the `CHAIN_ID`:

- Ethereum Mainnet: `1`
- Polygon: `137`
- Gnosis Chain: `100`
- Arbitrum: `42161`
- Optimism: `10`
- Base: `8453`

## Additional Resources

- [Safe Documentation](https://docs.safe.global/)
- [Safe SDK Documentation](https://docs.safe.global/sdk/overview)
- [Safe Transaction Service API](https://docs.safe.global/core-api/transaction-service-overview)
- [Safe Web App](https://app.safe.global/)

## Support

For issues or questions:
1. Check the troubleshooting section above
2. Review Safe SDK documentation
3. Verify all configuration values are correct
4. Check transaction files are properly formatted

## License

MIT

