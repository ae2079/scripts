# Safe Transaction Proposer

This tool allows you to programmatically propose batch transactions to Safe (Gnosis Safe) multisig wallets using the Safe SDK.

## What Does This Do?

This script takes transaction JSON files generated by:
- `../generateRemovePaymentsTransactions.js` - Removes payment streams
- `../pushPaymentTransactionGenerator.js` - Creates new vesting payment streams

And proposes them to your Safe multisig wallet, so other owners can review and approve them.

## Features

- ‚úÖ Proposes single transaction files or entire directories (batch mode)
- ‚úÖ **Automatic nonce management** - assigns sequential nonces to prevent conflicts
- ‚úÖ Uses Safe SDK for secure transaction submission
- ‚úÖ Verifies signer is a Safe owner before proposing
- ‚úÖ Provides detailed progress and summary reports with nonce tracking
- ‚úÖ Includes rate limiting protection between batches
- ‚úÖ Supports all Safe-compatible chains (Ethereum, Polygon, Arbitrum, etc.)

## Installation

Install the required dependencies:

```bash
cd SafeTransactionProposer
npm install
```

## Prerequisites

Before using this tool, you need:

1. **Transaction files**: Generated by the parent directory scripts
   - Run `node ../generateRemovePaymentsTransactions.js` or
   - Run `node ../pushPaymentTransactionGenerator.js`
   - This creates transaction JSON files in folders like `../X23/removePayment/` or `../X23/pushPayment/`

2. **Private key**: Of a Safe owner account (set as environment variable)

3. **Safe address**: The address of your Safe multisig wallet

## Usage

### Propose a Single Transaction File

```bash
node proposeSafeTransactions.js single ../X23/pushPayment/transactions_X23_batch1_20251012_0000.json
```

### Propose All Transactions in a Directory (Batch Mode) - Recommended

```bash
node proposeSafeTransactions.js batch ../X23/pushPayment
```

### With Custom Safe Address and Chain ID

```bash
node proposeSafeTransactions.js batch ../X23/pushPayment 0xYourSafeAddress 137
```

### Using NPM Scripts

You can also use the provided npm scripts:

```bash
# Propose a single transaction
npm run propose:single ../X23/pushPayment/transactions_X23_batch1.json

# Propose all transactions in a directory
npm run propose:batch ../X23/pushPayment
```

### Alternative: Without .env file

If you prefer not to use a `.env` file, you can pass the private key as an environment variable:

```bash
PRIVATE_KEY=0x... node proposeSafeTransactions.js batch ../X23/pushPayment
```

## Example Workflow

Here's a complete example from start to finish:

```bash
# 1. Generate transactions (in parent directory)
cd ..
node pushPaymentTransactionGenerator.js
# This creates files in ./X23/pushPayment/

# 2. Go to SafeTransactionProposer folder
cd SafeTransactionProposer

# 3. Install dependencies (first time only)
npm install

# 4. Setup your private key in .env file
cp .env.example .env
# Edit .env and add your PRIVATE_KEY

# 5. Propose all transactions to Safe
node proposeSafeTransactions.js batch ../X23/pushPayment
```

## Configuration

You have three ways to configure the script:

### 1. Using .env File (Recommended) üåü

Create a `.env` file (copy from `.env.example`):

```bash
# Required
PRIVATE_KEY=0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef

# Optional - Override defaults (usually not needed)
CHAIN_ID=137
RPC_URL=https://polygon-rpc.com
```

**Notes:**
- **‚ö†Ô∏è SECURITY**: The `.env` file is in `.gitignore` and will never be committed.
- **Safe Address**: Automatically extracted from transaction files (no config needed)
- **MultiSend Contract**: The script uses MultiSendCallOnly (0x9641d764fc13c8B624c04430C7356C1C7C8102e2) for batch transactions

### 2. Edit CONFIG in Code

Edit the `CONFIG` object in `proposeSafeTransactions.js`:

```javascript
const CONFIG = {
    CHAIN_ID: '137',        // Polygon Mainnet
    RPC_URL: 'https://polygon-rpc.com',
    // MultiSendCallOnly 1.4.1 contract - uses CALL instead of DELEGATE_CALL
    // Required for Safes with delegate calls disabled
    MULTI_SEND_CALL_ONLY_ADDRESS: '0x9641d764fc13c8B624c04430C7356C1C7C8102e2'
};
```

### 3. Command Line Arguments

Override Chain ID via command line:

```bash
node proposeSafeTransactions.js batch ../X23/pushPayment [CHAIN_ID]
```

Example:
```bash
node proposeSafeTransactions.js batch ../X23/pushPayment 137
```

### Priority Order

Configuration values are resolved in this order (highest to lowest priority):
1. Command line arguments
2. Environment variables (from `.env` file)
3. Default CONFIG values in code

## Security Best Practices

1. **Never commit private keys**: Always use environment variables or secure key management
2. **Use hardware wallets**: For production, consider using a hardware wallet integration
3. **Verify transactions**: Always review transactions in the Safe UI before executing
4. **Test first**: Use a test Safe on a testnet before proposing to mainnet
5. **Backup**: Keep backups of all generated transaction files

## How It Works

### Transaction Generation Flow

```
User Data ‚Üí Generator Script ‚Üí Transaction JSON Files ‚Üí Safe Transaction Builder Format
```

### Transaction Proposal Flow

```
Transaction JSON ‚Üí proposeSafeTransactions.js ‚Üí Safe SDK ‚Üí Safe API ‚Üí Safe UI
```

1. **Read**: Script reads transaction JSON files
2. **Initialize**: Connects to Safe using SDK with your private key
3. **Verify**: Checks that signer is a Safe owner
4. **Get Nonce**: Retrieves current Safe nonce
5. **Assign Nonces**: Assigns sequential nonces to each batch (e.g., 10, 11, 12...)
6. **Format**: Converts transactions to Safe SDK format
7. **Sign**: Signs each transaction with your private key
8. **Propose**: Submits to Safe Transaction Service
9. **View**: Transactions appear in Safe UI in correct order

### Nonce Management üî¢

When proposing **multiple batches**, the script automatically:
- Gets the current Safe nonce (e.g., 10)
- Assigns sequential nonces to each batch:
  - Batch 1 ‚Üí nonce 10
  - Batch 2 ‚Üí nonce 11
  - Batch 3 ‚Üí nonce 12
  - etc.

This prevents **nonce conflicts** where multiple transactions would have the same nonce and conflict with each other. Each batch gets its own unique nonce, ensuring they execute in the correct order.

## How MultiSend Works

When proposing multiple transactions in a batch, the script:

1. **Manually encodes** each transaction using the MultiSend format:
   - Operation (1 byte): `0` for CALL
   - To address (20 bytes)
   - Value (32 bytes)
   - Data length (32 bytes)
   - Transaction data (variable)

2. **Concatenates** all encoded transactions into a single byte array

3. **Creates a single Safe transaction** that DELEGATE_CALLs (operation 1) to the `multiSend(bytes)` function on the **MultiSendCallOnly** contract (`0x9641d764fc13c8B624c04430C7356C1C7C8102e2`)

4. **MultiSendCallOnly executes in the Safe's context** and makes CALL (operation 0) to each target address

This approach ensures that:
- ‚úÖ Safe DELEGATE_CALLs to MultiSendCallOnly (trusted Safe contract)
- ‚úÖ MultiSendCallOnly only makes CALLs to external addresses (not delegate calls)
- ‚úÖ Works with Safes that restrict DELEGATE_CALLs to untrusted contracts
- ‚úÖ Batch execution is atomic (all succeed or all fail)
- ‚úÖ More gas efficient than proposing individual transactions

## Transaction File Format

Generated transaction files follow the Safe Transaction Builder format:

```json
{
  "version": "1.0",
  "chainId": "137",
  "createdAt": 1234567890,
  "meta": {
    "name": "[PUSH-PAYMENTS]-[X23]-[QACC-ROUND-1]-[TX-0]",
    "description": "Batch 1 for X23"
  },
  "transactions": [
    {
      "to": "0x...",
      "value": "0",
      "data": "0x...",
      "contractMethod": "pushPayment(address,address,uint256,uint256,uint256,uint256)",
      "contractInputsValues": [...]
    }
  ]
}
```

## Troubleshooting

### "Signer is not an owner of Safe"
- Ensure the private key you're using belongs to a Safe owner
- Verify the Safe address is correct
- Check you're connected to the correct network

### "CGW error - 422: Delegate call is disabled" or "Operation DELEGATE_CALL is not allowed"
- **Fixed**: The script now **manually encodes** MultiSend transactions to use **MultiSendCallOnly** contract (0x9641d764fc13c8B624c04430C7356C1C7C8102e2)
- Safe DELEGATE_CALLs to MultiSendCallOnly (trusted contract), which then makes CALLs to external addresses
- This error occurred when using the regular MultiSend contract which DELEGATE_CALLs to external contracts
- The fix uses MultiSendCallOnly which restricts operations to CALLs only
- In the Safe UI, you should see:
  - **To**: 0x9641d764fc13c8B624c04430C7356C1C7C8102e2 (Safe: MultiSendCallOnly 1.4.1)
  - **Operation**: 1 (delegate call)
  - ‚úÖ This is correct! Safe delegates to MultiSendCallOnly, which then makes CALLs
- If you still see this error, verify your Safe settings and MultiSend contract address

### "Rate limiting" or "Too many requests"
- The script includes automatic delays between batches (2 seconds)
- If issues persist, increase `delayBetweenBatches` parameter
- Wait a few minutes and try again

### "Network error" or "RPC error"
- Check your internet connection
- Verify RPC_URL is accessible
- Try using a different RPC endpoint (e.g., Alchemy, Infura)

### "Transaction already proposed"
- This transaction hash already exists in the Safe
- Check the Safe UI to see existing pending transactions
- You can skip this transaction or use a different nonce

## Advanced Usage

### Custom RPC Endpoint

```bash
# Edit the CONFIG object in proposeSafeTransactions.js
const CONFIG = {
    RPC_URL: 'https://polygon-mainnet.g.alchemy.com/v2/YOUR_KEY',
    // ...
};
```

### Different Chains

The script supports any chain that Safe supports. Update the `CHAIN_ID`:

- Ethereum Mainnet: `1`
- Polygon: `137`
- Gnosis Chain: `100`
- Arbitrum: `42161`
- Optimism: `10`
- Base: `8453`

## Additional Resources

- [Safe Documentation](https://docs.safe.global/)
- [Safe SDK Documentation](https://docs.safe.global/sdk/overview)
- [Safe Transaction Service API](https://docs.safe.global/core-api/transaction-service-overview)
- [Safe Web App](https://app.safe.global/)

## Support

For issues or questions:
1. Check the troubleshooting section above
2. Review Safe SDK documentation
3. Verify all configuration values are correct
4. Check transaction files are properly formatted

## License

MIT

