# Generate Push Payment Transactions from Stream Data

This script generates `pushPayment` transactions based on existing stream data. It creates **two separate vestings** for each user:

1. **Immediate vesting** (1 second duration) for currently claimable tokens
2. **Weekly vesting** (7 days duration) for remaining unvested tokens

## üìã Overview

### How It Works

The script reads stream data generated by `fetchUserStreamData.js` and for each user:

1. **Calculates amounts**:
   - `Immediate amount` = `releasable` (claimable right now)
   - `Weekly amount` = `total - released - releasable` (unvested tokens)

2. **Creates transactions**:
   - First vesting: 1 second duration with immediate amount
   - Second vesting: 1 week (604,800 seconds) with weekly amount

3. **Generates Safe transaction files** compatible with Safe Transaction Builder

## üöÄ Quick Start

### 1. Navigate to the Folder

```bash
cd PushPaymentFromStreams
```

### 2. Install Dependencies

```bash
npm install
```

### 3. Fetch Stream Data (First Time)

If you don't have stream data yet, fetch it first:

```bash
cd ../saveStreamDetails
# Edit fetchUserStreamData.js to configure your project
node fetchUserStreamData.js
cd ../PushPaymentFromStreams
```

This creates a file like: `../X23/streamData/stream_data_X23_20250113_123456.json`

### 4. Configure the Script

Edit `generatePushPaymentFromStreams.js` and update these lines:

```javascript
// Line ~297
const streamDataFile = '../X23/streamData/stream_data_X23_20250113_123456.json';
const configFile = '../1.json'; // Original transaction file with addresses
```

### 5. Generate Transactions

```bash
node generatePushPaymentFromStreams.js
```

or

```bash
npm run generate
```

### 6. Propose to Safe

```bash
cd ../SafeTransactionProposer
npm run propose:batch ../X23/pushPayment
```

## üìÅ Input File Structures

### Stream Data File (from fetchUserStreamData.js)

```json
{
  "projectName": "X23",
  "client": "0x6B5d37c206D56B16F44b0C1b89002fd9B138e9Be",
  "paymentProcessor": "0xD6F574062E948d6B7F07c693f1b4240aFeA41657",
  "totalUsers": 150,
  "users": {
    "0x123...": {
      "address": "0x123...",
      "isActiveReceiver": true,
      "totalStreams": 2,
      "streams": [
        {
          "token": "0xABC...",
          "streamId": "1",
          "amount": "1000000000000000000000",    // Total vested
          "released": "300000000000000000000",   // Already claimed
          "releasable": "200000000000000000000", // Claimable now
          "start": "1234567890",
          "cliff": "0",
          "end": "1234567890"
        }
      ]
    }
  }
}
```

### Config File (original transaction report)

Used to extract:
- `projectName`
- `safe` address
- `paymentRouter` address  
- `issuanceToken` address

## üìä Output

### Transaction Files

Generated in `./[PROJECT_NAME]/pushPayment/` directory:

```
X23/
‚îî‚îÄ‚îÄ pushPayment/
    ‚îú‚îÄ‚îÄ transactions_X23_batch1_2025-01-13_12-34-56.json
    ‚îú‚îÄ‚îÄ transactions_X23_batch2_2025-01-13_12-34-56.json
    ‚îî‚îÄ‚îÄ ...
```

### Example Output

For a user with:
- Total: 1000 tokens
- Already claimed: 300 tokens
- Claimable now: 200 tokens
- Unvested: 500 tokens

The script generates **2 transactions**:

1. **Immediate vesting**: 200 tokens, 1 second duration
2. **Weekly vesting**: 500 tokens, 7 days duration

## üîß Configuration

### Batch Size

Default: 50 transactions per file. Change in script:

```javascript
const BATCH_SIZE = 50; // Line ~12
```

### Vesting Durations

To change vesting periods:

```javascript
const ONE_SECOND = 1;
const ONE_WEEK = 7 * 24 * 60 * 60; // Change to desired duration
```

### Weekly Vesting Start Time

Configure when the weekly vesting should start (line ~26):

```javascript
const WEEKLY_VESTING_START_TIMESTAMP = 0; // 0 = use current timestamp
```

**Options:**

1. **`0`** (default) - Use current timestamp (start immediately)
   ```javascript
   const WEEKLY_VESTING_START_TIMESTAMP = 0;
   ```
   Both immediate and weekly vestings start at the same time.

2. **Unix timestamp** - Start at a specific future date/time
   ```javascript
   const WEEKLY_VESTING_START_TIMESTAMP = 1736780000; // January 13, 2025 at 14:40:00 UTC
   const WEEKLY_VESTING_START_TIMESTAMP = 1739372400; // February 12, 2025 at 00:00:00 UTC
   ```
   Weekly vesting will start at the specified timestamp.

**Example Use Cases:**

- **Immediate start** (default): Set to `0` - both vestings start when transaction executes
- **Delayed start**: Set to a future timestamp - weekly vesting starts at that specific date/time

**Getting Unix Timestamps:**

- Online converter: https://www.unixtimestamp.com/
- JavaScript: `Math.floor(new Date('2025-01-13T14:40:00Z').getTime() / 1000)`
- Command line: `date -u -d "2025-01-13 14:40:00" +%s`

### Immediate Vesting Start Time

Configure when the immediate vesting (1 second duration) should start (line ~25):

```javascript
const IMMEDIATE_VESTING_START_TIMESTAMP = 0; // 0 = use current timestamp
```

**Options:**

1. **`0`** (default) - Use current timestamp (start immediately)
   ```javascript
   const IMMEDIATE_VESTING_START_TIMESTAMP = 0;
   ```
   Immediate vesting starts when the transaction executes.

2. **Unix timestamp** - Start at a specific future date/time
   ```javascript
   const IMMEDIATE_VESTING_START_TIMESTAMP = 1736780000; // January 13, 2025 at 14:40:00 UTC
   ```
   Immediate vesting will start at the specified timestamp.

## üìù Example Workflow

### Complete Example: X23 Project

```bash
# 1. Navigate to the folder
cd PushPaymentFromStreams

# 2. Install dependencies
npm install

# 3. Fetch current stream data
cd ../saveStreamDetails
node fetchUserStreamData.js
# Output: ../X23/streamData/stream_data_X23_20250113_123456.json

# 4. Edit generatePushPaymentFromStreams.js
# Update streamDataFile path to the generated file
cd ../PushPaymentFromStreams

# 5. Generate push payment transactions
node generatePushPaymentFromStreams.js
# Output: ../X23/pushPayment/transactions_X23_batch1_*.json

# 6. Review generated transactions
cat ../X23/pushPayment/transactions_X23_batch1_*.json | jq

# 7. Propose to Safe
cd ../SafeTransactionProposer
npm run propose:batch ../X23/pushPayment

# 8. Review in Safe UI
# Visit https://app.safe.global/transactions/queue?safe=matic:0xYourSafeAddress
```

## ‚ö†Ô∏è Important Notes

### Before Generating New Vestings

1. **Cancel old streams first**: Use `generateRemovePaymentsTransactions.js` to remove existing payment streams
2. **Execute removals**: Ensure all `removeAllPaymentReceiverPayments` transactions are executed before creating new ones
3. **Verify stream data**: Make sure you're using fresh stream data (run fetchUserStreamData.js again if needed)

### Address Checksumming

All addresses are automatically checksummed using `ethers.getAddress()` to ensure Safe compatibility.

### Transaction Validation

The script automatically:
- ‚úÖ Skips users with zero amounts
- ‚úÖ Skips users with errors in stream data
- ‚úÖ Aggregates multiple streams per user
- ‚úÖ Handles users who have fully claimed
- ‚úÖ Only creates transactions for non-zero amounts

## üêõ Troubleshooting

### "No transactions to generate"

**Cause**: All users have either:
- Fully claimed their tokens
- No streams found
- Errors in stream data

**Solution**: Check the console output to see why each user was skipped.

### "Error reading config file"

**Cause**: Config file path is incorrect or file structure doesn't match expected format.

**Solution**: 
- Verify the config file path
- Ensure it's a valid transaction report with `queries.addresses` fields

### "Cannot find module 'ethers'"

**Cause**: Dependencies not installed.

**Solution**: Run `npm install` in the VestingReset directory.

### Addresses not checksummed in output

**Cause**: This shouldn't happen as the script uses `ethers.getAddress()`.

**Solution**: Report as a bug if this occurs.

## üìö Related Scripts

- **`fetchUserStreamData.js`**: Fetches current stream data from blockchain
- **`generateRemovePaymentsTransactions.js`**: Generates transactions to remove existing streams
- **`pushPaymentTransactionGenerator.js`**: Original push payment generator (uses allocation amounts)
- **`SafeTransactionProposer/proposeSafeTransactions.js`**: Proposes transactions to Safe

## üîó Typical Workflow Order

1. `fetchUserStreamData.js` - Get current stream state
2. `generateRemovePaymentsTransactions.js` - Create removal transactions
3. **Execute removals in Safe** ‚ö†Ô∏è Important!
4. `generatePushPaymentFromStreams.js` - Create new vesting transactions (this script)
5. `proposeSafeTransactions.js` - Propose to Safe
6. **Execute in Safe** - Complete the vesting reset

## üí° Tips

- **Dry run**: Always review the generated transaction files before proposing
- **Test with one user**: Start with a test transaction for a single user
- **Backup data**: Keep copies of all stream data files
- **Monitor gas**: Large batches may require significant gas - check Safe gas estimates
- **Sequential processing**: Process removals and additions sequentially, never in parallel

## üéØ Summary

This script is part of the vesting reset workflow:

| Step | Script | Purpose |
|------|--------|---------|
| 1 | `fetchUserStreamData.js` | Get current state |
| 2 | `generateRemovePaymentsTransactions.js` | Cancel old vestings |
| 3 | Execute removals | Clear old streams |
| 4 | **`generatePushPaymentFromStreams.js`** | Create new vestings |
| 5 | `proposeSafeTransactions.js` | Propose to Safe |
| 6 | Execute in Safe | Apply changes |

